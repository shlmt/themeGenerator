<!DOCTYPE html>
<html lang="he" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Theme Builder — Refactoring UI Method</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #f8f8f6;
    --surface: #ffffff;
    --border: #e8e8e4;
    --border-strong: #d4d4ce;
    --text: #1a1a18;
    --text-muted: #6b6b65;
    --text-faint: #a8a8a2;
    --accent: #2563eb;
    --accent-light: #eff6ff;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #d97706;
    --radius: 8px;
    --radius-sm: 5px;
    --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.05);
  }

  body {
    font-family: 'DM Sans', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .badge {
    background: var(--accent-light);
    color: var(--accent);
    font-size: 11px;
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 20px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* LAYOUT */
  .layout {
    display: grid;
    grid-template-columns: 240px 1fr 300px;
    height: calc(100vh - 56px);
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--text-faint);
    margin-bottom: 10px;
  }

  .color-groups {
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow-y: auto;
    flex: 1;
    padding: 8px;
  }

  .group-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.12s;
    border: 1.5px solid transparent;
  }

  .group-item:hover { background: var(--bg); }
  .group-item.active {
    background: var(--accent-light);
    border-color: rgba(37, 99, 235, 0.2);
  }

  .group-swatch-strip {
    display: flex;
    gap: 1.5px;
    flex: 1;
    height: 18px;
    border-radius: 3px;
    overflow: hidden;
  }

  .group-swatch-strip span {
    flex: 1;
    display: block;
  }

  .group-info {
    min-width: 0;
  }

  .group-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .group-tag {
    font-size: 10px;
    color: var(--text-faint);
  }

  .group-actions {
    display: flex;
    gap: 2px;
    opacity: 0;
    transition: opacity 0.12s;
  }

  .group-item:hover .group-actions { opacity: 1; }

  .icon-btn {
    width: 22px;
    height: 22px;
    border: none;
    background: none;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
    transition: background 0.12s, color 0.12s;
    font-size: 12px;
  }

  .icon-btn:hover { background: var(--border); color: var(--text); }
  .icon-btn.danger:hover { background: #fee2e2; color: var(--danger); }

  .add-group-btn {
    margin: 8px;
    border: 1.5px dashed var(--border-strong);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    text-align: center;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 12px;
    font-weight: 500;
    transition: all 0.15s;
    background: none;
    width: calc(100% - 16px);
  }

  .add-group-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-light);
  }

  /* MAIN EDITOR */
  .editor {
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
  }

  .editor-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }

  .editor-title {
    font-size: 15px;
    font-weight: 600;
    flex: 1;
  }

  .editor-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* CARD */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
  }

  .card-title {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* BASE COLOR PICKER */
  .base-picker-row {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .color-picker-wrap {
    position: relative;
  }

  .color-picker-wrap input[type="color"] {
    width: 52px;
    height: 52px;
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    cursor: pointer;
    padding: 2px;
    background: none;
  }

  .base-info {
    flex: 1;
  }

  .base-hex {
    font-family: 'DM Mono', monospace;
    font-size: 15px;
    font-weight: 500;
    color: var(--text);
  }

  .base-hsl {
    font-size: 11px;
    color: var(--text-faint);
    font-family: 'DM Mono', monospace;
  }

  /* SHADE STRIP */
  .shade-strip {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 6px;
    margin-top: 4px;
  }

  .shade-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .shade-swatch {
    aspect-ratio: 1;
    border-radius: var(--radius-sm);
    cursor: pointer;
    border: 1.5px solid transparent;
    transition: transform 0.12s, box-shadow 0.12s;
    position: relative;
  }

  .shade-swatch:hover {
    transform: scaleY(1.15) translateY(-2px);
    box-shadow: var(--shadow-md);
    z-index: 2;
  }

  .shade-swatch.selected {
    border-color: var(--text);
    transform: scaleY(1.1) translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .shade-swatch input[type="color"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    border: none;
  }

  .shade-label {
    font-size: 10px;
    font-family: 'DM Mono', monospace;
    color: var(--text-faint);
    text-align: center;
    line-height: 1;
  }

  .shade-hex {
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    color: var(--text-faint);
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* TWEAK PANEL */
  .tweak-panel {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-top: 12px;
  }

  .tweak-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  .sliders {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .slider-row {
    display: grid;
    grid-template-columns: 60px 1fr 48px;
    align-items: center;
    gap: 10px;
  }

  .slider-label {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 500;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: var(--border);
    cursor: pointer;
    outline: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--text);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.15);
    transition: transform 0.1s;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    transform: scale(1.2);
  }

  .slider-value {
    font-size: 11px;
    font-family: 'DM Mono', monospace;
    color: var(--text);
    text-align: right;
  }

  /* PREVIEW */
  .preview-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .preview-card {
    border-radius: var(--radius-sm);
    padding: 12px;
    font-size: 12px;
  }

  .preview-card h4 {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 8px;
    opacity: 0.7;
  }

  /* SEMANTIC INDICATORS */
  .semantic-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }

  .semantic-badge {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    font-weight: 500;
  }

  /* RIGHT PANEL - EXPORT */
  .export-panel {
    background: var(--surface);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 4px;
    flex-shrink: 0;
    overflow-x: auto;
  }

  .tab {
    padding: 12px 14px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.12s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    margin-bottom: -1px;
  }

  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .export-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .code-block {
    background: #1a1a18;
    border-radius: var(--radius-sm);
    padding: 14px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: #e8e8e4;
    line-height: 1.7;
    overflow-x: auto;
    white-space: pre;
    position: relative;
  }

  .copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 4px;
    color: #a8a8a2;
    font-size: 11px;
    padding: 3px 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }

  .copy-btn:hover { background: rgba(255,255,255,0.18); color: white; }
  .copy-btn.copied { color: #4ade80; }

  /* BUTTONS */
  .btn {
    padding: 7px 14px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--text);
    color: white;
  }

  .btn-primary:hover { background: #333; }

  .btn-secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border-strong);
  }

  .btn-secondary:hover { background: var(--border); }

  .btn-sm {
    padding: 5px 10px;
    font-size: 12px;
  }

  /* MODAL */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--surface);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 24px;
    width: 420px;
    max-width: calc(100vw - 32px);
    transform: translateY(8px);
    transition: transform 0.15s;
  }

  .modal-overlay.open .modal { transform: translateY(0); }

  .modal h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .modal p {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: 14px;
    font-family: inherit;
    color: var(--text);
    background: var(--bg);
    transition: border-color 0.12s;
    outline: none;
  }

  .form-input:focus { border-color: var(--accent); }

  .type-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }

  .type-option {
    border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 10px 8px;
    cursor: pointer;
    text-align: center;
    transition: all 0.12s;
  }

  .type-option:hover { border-color: var(--border-strong); }

  .type-option.selected {
    border-color: var(--accent);
    background: var(--accent-light);
  }

  .type-option .type-icon { font-size: 20px; margin-bottom: 4px; }
  .type-option .type-name { font-size: 11px; font-weight: 600; }
  .type-option .type-desc { font-size: 10px; color: var(--text-faint); }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 20px;
  }

  /* EMPTY STATE */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
    gap: 12px;
  }

  .empty-icon { font-size: 48px; }
  .empty-title { font-size: 16px; font-weight: 600; color: var(--text); }
  .empty-desc { font-size: 13px; max-width: 280px; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 2px; }

  /* Contrast indicator */
  .contrast-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 3px;
  }

  .info-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-faint);
    margin-top: 6px;
  }

  /* Tone syntax highlight */
  .tok-comment { color: #6b7280; }
  .tok-prop { color: #93c5fd; }
  .tok-val { color: #86efac; }
  .tok-str { color: #fca5a5; }
  .tok-key { color: #fde68a; }
  .tok-punct { color: #d1d5db; }

  /* Section header in editor */
  .section-intro {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    display: flex;
    gap: 14px;
    align-items: flex-start;
    font-size: 12.5px;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .section-intro-icon { font-size: 22px; flex-shrink: 0; margin-top: 1px; }

  .usage-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 8px;
  }

  .chip {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 10px;
    padding: 2px 8px;
    color: var(--text-muted);
    font-weight: 500;
  }

  .export-info {
    font-size: 11px;
    color: var(--text-faint);
    line-height: 1.5;
    padding: 4px 0;
  }

  .divider {
    height: 1px;
    background: var(--border);
  }

  /* Custom color picker popover */
  .color-trigger-wrap {
    position: relative;
    display: inline-flex;
    align-items: center;
  }
  .color-trigger-swatch {
    width: 52px;
    height: 52px;
    border-radius: var(--radius-sm);
    border: 2px solid var(--border);
    cursor: pointer;
    transition: border-color 0.15s, transform 0.1s;
    flex-shrink: 0;
  }
  .color-trigger-swatch:hover { border-color: var(--border-strong); transform: scale(1.04); }
  .color-popover {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    z-index: 300;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-md);
    padding: 12px;
    display: none;
    flex-direction: column;
    gap: 8px;
    width: 220px;
  }
  .color-popover.open { display: flex; }
  .color-popover input[type="color"] {
    width: 100%;
    height: 90px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    padding: 0;
  }

  /* ===== MANUAL WIZARD ===== */
  .wizard-mode-toggle {
    display: flex;
    gap: 2px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 2px;
  }
  .wizard-mode-btn {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--text-muted);
    transition: all 0.12s;
    font-family: inherit;
  }
  .wizard-mode-btn.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Step progress bar */
  .wizard-steps {
    display: flex;
    gap: 0;
    margin-bottom: 18px;
    position: relative;
  }
  .wizard-steps::before {
    content: '';
    position: absolute;
    top: 14px;
    left: 14px;
    right: 14px;
    height: 2px;
    background: var(--border);
    z-index: 0;
  }
  .wizard-step-dot {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    position: relative;
    z-index: 1;
  }
  .wizard-step-circle {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    border: 2px solid var(--border);
    background: var(--surface);
    color: var(--text-faint);
    transition: all 0.2s;
    cursor: pointer;
  }
  .wizard-step-circle.done {
    background: var(--text);
    border-color: var(--text);
    color: white;
  }
  .wizard-step-circle.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
  }
  .wizard-step-label {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    color: var(--text-faint);
    text-align: center;
    line-height: 1.2;
  }
  .wizard-step-dot.active .wizard-step-label { color: var(--accent); }
  .wizard-step-dot.done .wizard-step-label { color: var(--text-muted); }

  /* Wizard content panel */
  .wizard-panel {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  .wizard-instruction {
    background: var(--accent-light);
    border: 1px solid rgba(37,99,235,0.15);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 12px;
    color: #1e40af;
    line-height: 1.6;
  }
  .wizard-instruction strong { font-weight: 700; }
  .wizard-instruction .step-num {
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-bottom: 3px;
    opacity: 0.7;
  }

  /* Color pickers row in wizard */
  .wizard-pickers {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }
  .wizard-picker-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
  }
  .wizard-picker-label {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }
  .wizard-swatch-btn {
    width: 52px;
    height: 52px;
    border-radius: var(--radius-sm);
    border: 2px solid var(--border);
    cursor: pointer;
    position: relative;
    overflow: visible;
    transition: transform 0.1s, border-color 0.15s;
  }
  .wizard-swatch-btn:hover { transform: scale(1.06); border-color: var(--border-strong); }
  .wizard-swatch-btn.shade-active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
  .wizard-swatch-btn input[type="color"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    border: none;
    padding: 0;
  }
  .wizard-swatch-hex {
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    color: var(--text-faint);
    text-align: center;
  }

  /* Wizard context preview */
  .wizard-context-preview {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }
  .wizard-context-label {
    background: var(--bg);
    padding: 6px 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-faint);
    border-bottom: 1px solid var(--border);
  }
  .wizard-context-body { padding: 12px; }

  /* Shade strip in wizard — with states */
  .wizard-shade-strip {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 4px;
  }
  .wizard-shade-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
  }
  .wizard-shade-swatch {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 4px;
    border: 2px solid transparent;
    position: relative;
    transition: transform 0.1s;
  }
  .wizard-shade-swatch.set { border-color: rgba(0,0,0,0.12); }
  .wizard-shade-swatch.current {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(37,99,235,0.2);
    transform: scaleY(1.12) translateY(-2px);
  }
  .wizard-shade-swatch.interpolated { opacity: 0.45; border-style: dashed; border-color: var(--border-strong); }
  .wizard-shade-swatch.empty { background: var(--bg) !important; border: 2px dashed var(--border); }
  .wizard-shade-num {
    font-size: 9px;
    font-family: 'DM Mono', monospace;
    color: var(--text-faint);
    text-align: center;
  }

  /* Wizard nav buttons */
  .wizard-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
    padding-top: 14px;
    border-top: 1px solid var(--border);
  }
  .wizard-nav-info {
    font-size: 11px;
    color: var(--text-faint);
  }

  .palette-overview {
    display: flex;
    height: 28px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .palette-overview span {
    flex: 1;
    display: block;
  }

</style>
</head>
<body>

<header>
  <div class="header-left">
    <span class="logo">🎨 Theme Builder</span>
    <span class="badge">Refactoring UI Method</span>
    <a href="https://refactoringui.com/previews/building-your-color-palette/" target="_blank" rel="noopener"
       style="font-size:11px;color:var(--text-muted);text-decoration:none;display:flex;align-items:center;gap:4px;padding:3px 8px;border:1px solid var(--border);border-radius:20px;transition:all 0.12s;"
       onmouseover="this.style.borderColor='var(--border-strong)';this.style.color='var(--text)'"
       onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)'">
      <svg width="11" height="11" viewBox="0 0 12 12" fill="none"><path d="M5 2H2v8h8V7M7 1h4m0 0v4m0-4L5.5 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Read the article
    </a>
  </div>
  <div class="header-right">
    <button class="btn btn-secondary btn-sm" onclick="resetAll()">↺ Reset</button>
    <button class="btn btn-primary btn-sm" onclick="showExportAll()">↓ Export All</button>
  </div>
</header>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Color Groups</div>
    </div>
    <div class="color-groups" id="colorGroups"></div>
    <button class="add-group-btn" onclick="openAddModal()">+ Add Color Group</button>
  </aside>

  <!-- MAIN EDITOR -->
  <main class="editor">
    <div id="editorContent" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
      <div class="empty-state" id="emptyState" style="display:none;">
        <div class="empty-icon">🎨</div>
        <div class="empty-title">No color groups</div>
        <div class="empty-desc">לחץ על "+ Add Color Group" בצד שמאל כדי להוסיף קבוצת צבעים.</div>
      </div>
      <div id="shadeEditor" style="display:none;flex-direction:column;height:100%;overflow:hidden;">
        <div class="editor-header">
          <div>
            <div class="editor-title" id="editorGroupName">Grey</div>
            <div style="font-size:11px; color: var(--text-faint);" id="editorGroupDesc">Text, backgrounds, panels, form controls</div>
          </div>
        </div>
        <div class="editor-body" id="editorBody">
          <!-- dynamic content -->
        </div>
      </div>
    </div>
  </main>

  <!-- RIGHT PANEL - EXPORT -->
  <aside class="export-panel">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('css',this)">CSS Variables</button>
      <button class="tab" onclick="switchTab('tailwind',this)">Tailwind</button>
      <button class="tab" onclick="switchTab('mui',this)">MUI</button>
    </div>
    <div class="export-body" id="exportBody">
      <div class="export-info">הצבעים יוצגו כאן לאחר שתגדיר לפחות קבוצה אחת.</div>
    </div>
  </aside>
</div>

<!-- ADD GROUP MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Add Color Group</h3>
    <p>Choose the type of color group to add to your palette.</p>
    <div class="type-grid" style="grid-template-columns:repeat(3,1fr);">
      <div class="type-option selected" data-type="grey" onclick="selectType('grey',this)">
        <div class="type-icon">◻</div>
        <div class="type-name">Neutral</div>
        <div class="type-desc">Backgrounds & text</div>
      </div>
      <div class="type-option" data-type="primary" onclick="selectType('primary',this)">
        <div class="type-icon">◆</div>
        <div class="type-name">Primary</div>
        <div class="type-desc">Brand / CTA color</div>
      </div>
      <div class="type-option" data-type="error" onclick="selectType('error',this)">
        <div class="type-icon">✕</div>
        <div class="type-name">Error</div>
        <div class="type-desc">Destructive / critical</div>
      </div>
      <div class="type-option" data-type="warning" onclick="selectType('warning',this)">
        <div class="type-icon">!</div>
        <div class="type-name">Warning</div>
        <div class="type-desc">Caution states</div>
      </div>
      <div class="type-option" data-type="success" onclick="selectType('success',this)">
        <div class="type-icon">✓</div>
        <div class="type-name">Success</div>
        <div class="type-desc">Positive / confirmed</div>
      </div>
      <div class="type-option" data-type="highlight" onclick="selectType('highlight',this)">
        <div class="type-icon">★</div>
        <div class="type-name">Highlight</div>
        <div class="type-desc">Feature / promo badges</div>
      </div>
      <div class="type-option" data-type="accent" onclick="selectType('accent',this)">
        <div class="type-icon">●</div>
        <div class="type-name">Accent</div>
        <div class="type-desc">Anything you want</div>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Name</label>
      <input class="form-input" id="modalName" type="text" placeholder="e.g. Primary, Error, Warning, Success…" />
    </div>
    <div class="form-group">
      <label class="form-label">Shade Count (1–9)</label>
      <input class="form-input" id="modalShadeCount" type="number" min="1" max="9" value="9" />
    </div>
    <div class="form-group">
      <label class="form-label">Base Color (500)</label>
      <div style="display:flex; gap:10px; align-items:center;">
        <input type="color" id="modalColor" value="#2563eb" style="width:48px;height:40px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer;padding:2px;">
        <input class="form-input" id="modalHex" type="text" placeholder="#2563eb" style="flex:1;font-family:'DM Mono',monospace;" oninput="syncModalColor()" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddGroup()">Add Group</button>
    </div>
  </div>
</div>

<script>
// ==================== COLOR MATH ====================

function hexToRgb(hex) {
  if(!hex || typeof hex !== 'string') return [0,0,0];
  hex = hex.replace('#','');
  if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  if(hex.length !== 6) return [0,0,0];
  const n = parseInt(hex, 16);
  return [(n>>16)&255, (n>>8)&255, n&255];
}

function rgbToHex(r,g,b) {
  return '#' + [r,g,b].map(v => Math.round(Math.max(0,Math.min(255,v))).toString(16).padStart(2,'0')).join('');
}

function rgbToHsl(r,g,b) {
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b), min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min) { h=s=0; }
  else {
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max) {
      case r: h=((g-b)/d+(g<b?6:0))/6; break;
      case g: h=((b-r)/d+2)/6; break;
      case b: h=((r-g)/d+4)/6; break;
    }
  }
  return [Math.round(h*360), Math.round(s*100), Math.round(l*100)];
}

function hslToRgb(h,s,l) {
  h/=360; s/=100; l/=100;
  let r,g,b;
  if(s===0) { r=g=b=l; }
  else {
    const hue2rgb=(p,q,t)=>{
      if(t<0)t+=1; if(t>1)t-=1;
      if(t<1/6)return p+(q-p)*6*t;
      if(t<1/2)return q;
      if(t<2/3)return p+(q-p)*(2/3-t)*6;
      return p;
    };
    const q=l<0.5?l*(1+s):l+s-l*s, p=2*l-q;
    r=hue2rgb(p,q,h+1/3);
    g=hue2rgb(p,q,h);
    b=hue2rgb(p,q,h-1/3);
  }
  return [Math.round(r*255), Math.round(g*255), Math.round(b*255)];
}

function hslToHex(h,s,l) {
  return rgbToHex(...hslToRgb(h,s,l));
}

function hexToHsl(hex) {
  return rgbToHsl(...hexToRgb(hex));
}

const SHADE_NAMES_ALL = [100,200,300,400,500,600,700,800,900];

function getShadeIndices(count) {
  const safeCount = Math.max(1, Math.min(9, count || 9));
  if(safeCount === 1) return [4];
  if(safeCount === 9) return [0,1,2,3,4,5,6,7,8];

  const step = 8 / (safeCount - 1);
  const idxs = Array.from({length: safeCount}, (_, i) => Math.round(i * step));

  // Ensure base index (4) is included for consistent 500 shade usage
  if(!idxs.includes(4)) {
    const mid = Math.floor(idxs.length / 2);
    idxs[mid] = 4;
  }

  // De-dup and sort (keep count by nudging if needed)
  const unique = Array.from(new Set(idxs)).sort((a,b)=>a-b);
  while(unique.length < safeCount) {
    for(let i = 0; i < 9 && unique.length < safeCount; i++) {
      if(!unique.includes(i)) unique.push(i);
    }
  }
  return unique.slice(0, safeCount).sort((a,b)=>a-b);
}

// Smart shade generation based on Refactoring UI method
// shades: 100(lightest) → 900(darkest), base at 500
function generateShades(baseHex, type='primary', count=9) {
  const [h,s,l] = hexToHsl(baseHex);

  // Lightness targets for 100-900
  let lightTargets, satTargets;

  if(type === 'grey') {
    lightTargets = [97, 93, 87, 79, 68, 54, 40, 28, 16];
    // Greys: keep slight saturation for warmth
    satTargets = Array(9).fill(Math.min(s, 15));
  } else {
    // For colors: spread lightness, keep hue, adjust sat
    // 100=very light, 500=base, 900=very dark
    lightTargets = [95, 88, 79, 68, l, Math.max(l-15,20), Math.max(l-26,14), Math.max(l-35,9), Math.max(l-42,5)];
    // Saturation curve: lower at extremes
    const baseSat = Math.min(s, 90);
    satTargets = [
      Math.min(baseSat*0.35, 40),
      Math.min(baseSat*0.55, 55),
      Math.min(baseSat*0.75, 70),
      Math.min(baseSat*0.9, 80),
      baseSat,
      Math.min(baseSat*1.05, 95),
      Math.min(baseSat*1.1, 100),
      Math.min(baseSat*1.05, 100),
      Math.min(baseSat*0.95, 100),
    ];

    // If base is very bright, don't push extremes too far
    const brightCompress =
      l >= 75 ? 0.75 :
      l >= 65 ? 0.85 :
      l >= 55 ? 0.9 : 1;
    if(brightCompress < 1) {
      lightTargets = lightTargets.map(t => l + (t - l) * brightCompress);
    }

    // Enforce clear lightness ordering around the base
    const minStep = 4;
    lightTargets = lightTargets.map((t, i) => {
      if(i < 4) return Math.max(t, l + (4 - i) * minStep);
      if(i > 4) return Math.min(t, l - (i - 4) * minStep);
      return l;
    });

    // Reduce saturation overall so shades feel calmer
    const satReduce =
      l >= 75 ? 0.9 :
      l >= 65 ? 0.92 :
      l >= 55 ? 0.95 : 0.97;
    satTargets = satTargets.map(t => t * satReduce);

    // Keep warm/low-sat colors from turning gray
    const isWarm = h >= 15 && h <= 70;
    const satFloor = Math.max(10, baseSat * 0.6);
    satTargets = satTargets.map((t, i) => {
      let v = Math.max(t, satFloor);
      if(isWarm && baseSat < 45) {
        const boost = i >= 4 ? 6 : 2;
        v = Math.max(v, baseSat * 0.75 + boost);
      }
      return v;
    });
  }

  const shadesAll = SHADE_NAMES_ALL.map((name, i) => ({
    name,
    hex: i === 4
      ? baseHex
      : hslToHex(h, Math.max(0, Math.min(100, satTargets[i])), Math.max(2, Math.min(98, lightTargets[i])))
  }));

  const idxs = getShadeIndices(count);
  return idxs.map(i => shadesAll[i]);
}

// Luminance for contrast calculation
function getLuminance(hex) {
  return rgbToHsl(...hexToRgb(hex))[2];
}

// ==================== STATE ====================

let groups = [];
let activeGroupId = null;
let selectedShadeIdx = null;
let currentTab = 'css';

function uid() { return Math.random().toString(36).slice(2,8); }

// ==================== GROUP MANAGEMENT ====================

function addGroup(name, type, baseHex, shadeCount=9) {
  const id = uid();
  const genType = type === 'grey' ? 'grey' : 'primary';
  const shades = generateShades(baseHex, genType, shadeCount);
  groups.push({ id, name, type, baseHex, shades, manualMode: false, wizardStep: 1 });
  renderSidebar();
  setActiveGroup(id);
  renderExport();
}

function removeGroup(id) {
  groups = groups.filter(g => g.id !== id);
  if(activeGroupId === id) {
    activeGroupId = groups.length ? groups[0].id : null;
  }
  renderSidebar();
  renderEditor();
  renderExport();
}

function setActiveGroup(id) {
  activeGroupId = id;
  selectedShadeIdx = null;
  renderSidebar();
  renderEditor();
}

function getActiveGroup() {
  return groups.find(g => g.id === activeGroupId);
}

// ==================== DEFAULTS ====================

function addDefaultGroups() {
  groups = [];
  activeGroupId = null;

  const names = SHADE_NAMES_ALL;
  const defaults = [
    {
      name: 'Neutral',
      type: 'grey',
      baseHex: '#aebecd',
      shades: ['#f8f9fa','#e1e7ec','#d5dde5','#ccd4db','#aebecd','#929fb1','#6e7a8a','#404b5a','#202833'],
    },
    {
      name: 'Primary',
      type: 'primary',
      baseHex: '#6175de',
      shades: ['#f0f4fe','#d4def8','#95aeed','#758ce0','#6175de','#495dc6','#3547a4','#253586'],
    },
    {
      name: 'Error',
      type: 'error',
      baseHex: '#b82020',
      shades: ['#fce8e8','#f5aaaa','#e46464','#dc3030','#b82020','#891b1b','#611818'],
    },
    {
      name: 'Warning',
      type: 'warning',
      baseHex: '#caa53d',
      shades: ['#fffcf4','#fdf3d7','#fae29f','#f4ca64','#caa53d','#8c6d1f','#5c4813'],
    },
    {
      name: 'Success',
      type: 'success',
      baseHex: '#259d58',
      shades: ['#e3fcec','#a8eec1','#74d99f','#38c172','#259d58','#197741','#145239'],
    },
    {
      name: 'Highlight',
      type: 'highlight',
      baseHex: '#2a9187',
      shades: ['#e7fffe','#a8eeeb','#6ed7d3','#3caea3','#2a9187','#1b655e','#124544'],
    },
  ];

  defaults.forEach(p => {
    const id = uid();
    const shades = names.map((name, i) => ({ name, hex: p.shades[i] }));
    groups.push({ id, name: p.name, type: p.type, baseHex: p.baseHex, shades, manualMode: false, wizardStep: 1 });
  });

  activeGroupId = groups.length ? groups[0].id : null;
  renderSidebar();
  renderEditor();
  renderExport();
}

function resetAll() {
  if(!confirm('Reset all groups and start fresh?')) return;
  groups = [];
  activeGroupId = null;
  addDefaultGroups();
}

// ==================== RENDER SIDEBAR ====================

function renderSidebar() {
  const el = document.getElementById('colorGroups');
  if(groups.length === 0) {
    el.innerHTML = '';
    return;
  }

  // Semantic role labels in sidebar
  const roleLabel = (g) => {
    const labels = { grey:'Neutral', primary:'Primary', error:'Error', warning:'Warning', success:'Success', highlight:'Highlight', accent:'Accent' };
    return labels[g.type] || 'Accent';
  };

  const roleIcon = (g) => {
    const icons = { grey:'◻', primary:'◆', error:'✕', warning:'!', success:'✓', highlight:'★', accent:'●' };
    return icons[g.type] || '●';
  };

  el.innerHTML = groups.map(g => {
    const strip = g.shades.map(s => `<span style="background:${s.hex}"></span>`).join('');
    return `
    <div class="group-item ${g.id===activeGroupId?'active':''}" onclick="setActiveGroup('${g.id}')">
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
          <span style="font-size:10px;font-weight:700;font-family:'DM Mono',monospace;color:${g.id===activeGroupId?'var(--accent)':'var(--text-faint)'};">${roleIcon(g)}</span>
          <span class="group-name">${g.name}</span>
          <span style="font-size:9px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:1px 6px;color:var(--text-faint);font-weight:600;letter-spacing:0.3px;">${roleLabel(g)}</span>
        </div>
        <div class="group-swatch-strip">${strip}</div>
      </div>
      <div class="group-actions">
        <button class="icon-btn danger" onclick="event.stopPropagation();removeGroup('${g.id}')" title="Delete">✕</button>
      </div>
    </div>`;
  }).join('');
}

// ==================== RENDER EDITOR ====================

const typeDescriptions = {
  grey:      'Text, backgrounds, panels, form controls — almost everything in an interface',
  primary:   'Used for primary actions, emphasizing navigation elements, and determining the overall look',
  error:     'Destructive actions, validation errors, critical alerts — must be immediately clear',
  warning:   'Cautionary states, non-critical issues, degraded conditions that need attention',
  success:   'Confirmed actions, completed states, positive feedback — green-light signal',
  highlight: 'Feature callouts, "New" badges, promotional banners — grabs attention without alarm',
  accent:    'Secondary semantic color — communicates a distinct state or category',
};

// Per-semantic-role shade hints
const typeHints = {
  grey: {
    100: 'Page / app background',
    200: 'Card & panel surface',
    300: 'Borders, dividers',
    400: 'Disabled & placeholder',
    500: 'Muted labels, captions',
    600: 'Secondary body text',
    700: 'Primary body text',
    800: 'Headings',
    900: 'Near-black — darkest text',
  },
  primary: {
    100: 'Tinted background (hover, selected row)',
    200: 'Tag / chip background',
    300: 'Disabled primary button',
    400: 'Outline button hover',
    500: 'Primary button, links ← BASE',
    600: 'Primary button :hover',
    700: 'Primary button :active',
    800: 'Dark-mode button surface',
    900: 'Text on light-primary bg',
  },
  error: {
    100: 'Error banner background',
    200: 'Hover tint on error row',
    300: 'Error input border',
    400: 'Error icon (on light bg)',
    500: 'Error icon / badge ← BASE',
    600: 'Error button bg',
    700: 'Error text on light bg',
    800: 'Error heading on light bg',
    900: 'Error text on tinted bg',
  },
  warning: {
    100: 'Warning banner background',
    200: 'Warning row hover tint',
    300: 'Warning border / outline',
    400: 'Warning icon (on light bg)',
    500: 'Warning icon / badge ← BASE',
    600: 'Warning button bg',
    700: 'Warning text on light bg',
    800: 'Warning label on light bg',
    900: 'Warning text on tinted bg',
  },
  success: {
    100: 'Success banner background',
    200: 'Checked-row tint',
    300: 'Success border / outline',
    400: 'Success icon (on light bg)',
    500: 'Success icon / badge ← BASE',
    600: 'Success button bg',
    700: 'Success text on light bg',
    800: 'Success label on light bg',
    900: 'Success text on tinted bg',
  },
  highlight: {
    100: '"New" feature banner bg',
    200: 'Promo tag background',
    300: 'Highlight border',
    400: 'Highlight icon (light bg)',
    500: '"New" badge / promo pill ← BASE',
    600: 'Highlight button bg',
    700: 'Highlight text on light bg',
    800: 'Highlight label on light bg',
    900: 'Highlight text on tinted bg',
  },
  accent: {
    100: 'Alert background',
    200: 'Hover tint',
    300: 'Border / outline',
    400: 'Secondary indicator',
    500: 'Icon, badge background ← BASE',
    600: 'Darker badge/chip',
    700: 'Text on light bg',
    800: 'Strong text, high contrast',
    900: 'Text on tinted bg',
  },
};

function clamp(val, min, max) {
  return Math.max(min, Math.min(max, val));
}

function normalizeHueAround(value, ref) {
  let v = value;
  while(v - ref > 180) v -= 360;
  while(v - ref < -180) v += 360;
  return v;
}

function getHslRanges(g, idx, h, s, l) {
  const prev = idx > 0 ? hexToHsl(g.shades[idx-1].hex) : null;
  const next = idx < 8 ? hexToHsl(g.shades[idx+1].hex) : null;

  // Lightness: keep ordering (100 lightest -> 900 darkest)
  const prevL = prev ? prev[2] : 98;
  const nextL = next ? next[2] : 2;
  let lMin = Math.max(nextL + 2, 2);
  let lMax = Math.min(prevL - 2, 98);
  if(lMin > lMax) {
    const mid = clamp(l, 2, 98);
    lMin = mid;
    lMax = mid;
  }

  // Saturation: gentle range around neighbors
  let sMin = 0;
  let sMax = 100;
  if(prev && next) {
    sMin = Math.max(0, Math.min(prev[1], next[1]) - 8);
    sMax = Math.min(100, Math.max(prev[1], next[1]) + 8);
  } else if(prev) {
    sMin = Math.max(0, prev[1] - 12);
    sMax = Math.min(100, prev[1] + 12);
  } else if(next) {
    sMin = Math.max(0, next[1] - 12);
    sMax = Math.min(100, next[1] + 12);
  }
  if(sMin > sMax) {
    const mid = clamp(s, 0, 100);
    sMin = mid;
    sMax = mid;
  }

  // Hue: constrain near neighbors without wrap glitches
  let hMin = 0;
  let hMax = 360;
  const prevH = prev ? normalizeHueAround(prev[0], h) : null;
  const nextH = next ? normalizeHueAround(next[0], h) : null;
  if(prevH !== null && nextH !== null) {
    hMin = Math.min(prevH, nextH) - 10;
    hMax = Math.max(prevH, nextH) + 10;
  } else if(prevH !== null) {
    hMin = prevH - 15;
    hMax = prevH + 15;
  } else if(nextH !== null) {
    hMin = nextH - 15;
    hMax = nextH + 15;
  }
  if(hMin < 0 || hMax > 360) {
    hMin = 0;
    hMax = 360;
  }

  return {
    h: { min: Math.round(hMin), max: Math.round(hMax) },
    s: { min: Math.round(sMin), max: Math.round(sMax) },
    l: { min: Math.round(lMin), max: Math.round(lMax) },
  };
}

function renderEditor() {
  const g = getActiveGroup();
  const empty = document.getElementById('emptyState');
  const editor = document.getElementById('shadeEditor');

  if(!g) {
    empty.style.display = 'flex';
    editor.style.display = 'none';
    return;
  }

  empty.style.display = 'none';
  editor.style.display = 'flex';

  const desc = typeDescriptions[g.type] || typeDescriptions.accent;
  document.getElementById('editorGroupName').textContent = `${g.name}`;
  document.getElementById('editorGroupDesc').textContent = desc;

  const [bh,bs,bl] = hexToHsl(g.baseHex);
  const hints = typeHints[g.type] || typeHints.accent;
  const canWizard = g.shades.length === 9;
  if(!canWizard && g.manualMode) {
    g.manualMode = false;
    g.wizardStep = 1;
    g.wizardSet = null;
  }

  let tweakHtml = '';
  if(selectedShadeIdx !== null) {
    const sh = g.shades[selectedShadeIdx];
    const [h,s,l] = hexToHsl(sh.hex);
    const ranges = getHslRanges(g, selectedShadeIdx, h, s, l);

    const clampedH = clamp(h, ranges.h.min, ranges.h.max);
    const clampedS = clamp(s, ranges.s.min, ranges.s.max);
    const clampedL = clamp(l, ranges.l.min, ranges.l.max);



    tweakHtml = `
    <div class=\"tweak-panel\">
      <div class=\"tweak-title\">
        Fine-tune ${sh.name}
        <span style=\"font-size:10px;color:var(--text-faint);font-weight:400;margin-left:4px;\">- HSL ranges constrained between neighbors</span>
      </div>
      <div class=\"sliders\">
        <div class=\"slider-row\">
          <span class=\"slider-label\">Hue</span>
          <input type=\"range\" min=\"${ranges.h.min}\" max=\"${ranges.h.max}\" value=\"${clampedH}\" oninput=\"tweakShade(${selectedShadeIdx},'h',this.value)\" id=\"slH\">
          <span class=\"slider-value\" id=\"slHv\">${clampedH}deg</span>
        </div>
        <div class=\"slider-row\">
          <span class=\"slider-label\">Saturation</span>
          <input type=\"range\" min=\"${ranges.s.min}\" max=\"${ranges.s.max}\" value=\"${clampedS}\" oninput=\"tweakShade(${selectedShadeIdx},'s',this.value)\" id=\"slS\">
          <span class=\"slider-value\" id=\"slSv\">${clampedS}%</span>
        </div>
        <div class=\"slider-row\">
          <span class=\"slider-label\">Lightness</span>
          <input type=\"range\" min=\"${ranges.l.min}\" max=\"${ranges.l.max}\" value=\"${clampedL}\" oninput=\"tweakShade(${selectedShadeIdx},'l',this.value)\" id=\"slL\">
          <span class=\"slider-value\" id=\"slLv\">${clampedL}%</span>
        </div>
      </div>
      <div style=\"margin-top:10px;display:flex;align-items:center;justify-content:space-between;\">
        <span style=\"font-size:11px;color:var(--text-muted);\">Use for: <strong>${hints[sh.name]||''}</strong></span>
        <span style=\"font-size:11px;font-family:'DM Mono',monospace;color:var(--text-faint);\">${sh.hex}</span>
      </div>
    </div>`;
  }

  const lum = getLuminance(g.baseHex);
  const textContrast = lum > 55 ? 'Dark text recommended on 500' : 'Light text recommended on 500';

  const body = document.getElementById('editorBody');
  body.innerHTML = `
    <div class="section-intro">
      <div class="section-intro-icon">${g.type==='grey'?'🔘':g.type==='primary'?'💎':g.type==='error'?'⛔':g.type==='warning'?'⚠️':g.type==='success'?'✅':g.type==='highlight'?'✨':'🎯'}</div>
      <div>
        <div style="font-weight:600;color:var(--text);margin-bottom:4px;">${g.name} — ${g.type.charAt(0).toUpperCase()+g.type.slice(1)} Color Scale (100–900)</div>
        <div>${desc}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Base Color (500)</div>
      <div class="base-picker-row">
        <div class="color-picker-wrap">
          <input type="color" value="${g.baseHex}" oninput="updateBase(this.value)" onchange="updateBase(this.value)">
        </div>
        <div class="base-info">
          <div class="base-hex">${g.baseHex}</div>
          <div class="base-hsl">hsl(${bh}, ${bs}%, ${bl}%)</div>
          <div style="font-size:11px;color:var(--text-faint);margin-top:2px;">${textContrast}</div>
        </div>
        <div style="width:80px;height:52px;border-radius:6px;background:${g.baseHex};border:1px solid rgba(0,0,0,0.08);"></div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div class="card-title" style="margin-bottom:0;">${g.shades.length} Shades</div>
        <div style="display:flex;align-items:center;gap:8px;">
          ${g.manualMode ? '' : `<button class="btn btn-secondary btn-sm" onclick="autoGenerate()" id="autoGenBtn">⚡ Auto-Generate Shades</button>`}
          <div class="wizard-mode-toggle">
            <button class="wizard-mode-btn ${!g.manualMode?'active':''}" onclick="setMode(false)">⚡ Auto</button>
            <button class="wizard-mode-btn ${g.manualMode?'active':''}" onclick="setMode(true)" ${!canWizard ? 'disabled style="opacity:0.4;cursor:not-allowed;"' : ''}>✏️ Manual Build</button>
          </div>
        </div>
      </div>
      ${(g.manualMode && canWizard) ? renderWizard(g, hints) : renderAutoStrip(g, hints, tweakHtml)}
    </div>

    <div class="card">
      <div class="card-title">Preview</div>
      <div class="preview-grid">
        ${renderPreviewCard(g)}
      </div>
    </div>
  `;
}

// ==================== AUTO STRIP ====================

function renderAutoStrip(g, hints, tweakHtml) {
  return `
    <div class="shade-strip" id="shadeStrip" style="grid-template-columns:repeat(${g.shades.length},1fr)">
      ${g.shades.map((sh,i) => {
        const lum2 = getLuminance(sh.hex);
        const textCol = lum2 > 55 ? '#1a1a18' : '#ffffff';
        const isSelected = selectedShadeIdx === i;
        const usage = hints[sh.name] || '';
        return `
        <div class="shade-item">
          <div class="shade-swatch ${isSelected?'selected':''}" style="background:${sh.hex};" onclick="selectShade(${i})" title="${sh.name}: ${sh.hex}">
            ${isSelected?`<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:10px;color:${textCol};font-weight:700;">✓</div>`:''}
          </div>
          <div class="shade-label">${sh.name}</div>
          <div class="shade-hex">${sh.hex}</div>
          <div style="font-size:9px;color:var(--text-faint);text-align:center;line-height:1.3;margin-top:3px;word-break:break-word;">${usage}</div>
        </div>`;
      }).join('')}
    </div>
    ${tweakHtml}`;
}

// ==================== MANUAL WIZARD ====================
// Shade indices: 0=100, 1=200, ..., 4=500, ..., 8=900
// Step 1: Set base (500) → index 4
// Step 2: Set edges — 100 (index 0) and 900 (index 8)
// Step 3: Set midpoints — 300 (index 2) and 700 (index 6)
// Step 4: Fill remaining — 200 (1), 400 (3), 600 (5), 800 (7)

const WIZARD_STEPS = [
  {
    id: 1,
    title: 'Choose the Base Color',
    subtitle: 'Step 1 of 4',
    shadeIndices: [4], // 500
    instruction: `<div class="step-num">Step 1 — Base Color</div>Pick a color that would work well as a <strong>button background</strong>. This becomes shade 500 — the anchor of the whole scale. There's no right lightness rule here: trust your eye.`,
    previewType: 'button',
  },
  {
    id: 2,
    title: 'Find the Edges',
    subtitle: 'Step 2 of 4',
    shadeIndices: [0, 8], // 100 and 900
    instruction: `<div class="step-num">Step 2 — Edges (100 & 900)</div>Pick your <strong>lightest shade (100)</strong> — used as an alert / tinted background. Then pick your <strong>darkest shade (900)</strong> — used for text. An alert component is the perfect test: it uses both at once.`,
    previewType: 'alert',
  },
  {
    id: 3,
    title: 'Fill the Midpoints',
    subtitle: 'Step 3 of 4',
    shadeIndices: [2, 6], // 300 and 700
    instruction: `<div class="step-num">Step 3 — Midpoints (300 & 700)</div>Pick shades <strong>300 and 700</strong> — they sit right in the middle of each gap. They should feel like a natural compromise between their neighbors on either side.`,
    previewType: 'range',
  },
  {
    id: 4,
    title: 'Fill the Gaps',
    subtitle: 'Step 4 of 4',
    shadeIndices: [1, 3, 5, 7], // 200, 400, 600, 800
    instruction: `<div class="step-num">Step 4 — Fill the Gaps (200, 400, 600, 800)</div>Finally, fill in the four remaining holes. Each should feel like a natural step between its neighbors. The interpolated suggestions are a good starting point — trust your eyes for the final call.`,
    previewType: 'full',
  },
];

// Names for each index
const SHADE_NAMES = SHADE_NAMES_ALL;

// Interpolate a single missing shade between prev and next
function interpolateShade(prevHex, nextHex, ratio) {
  // interpolate in HSL space
  const [h1,s1,l1] = hexToHsl(prevHex);
  const [h2,s2,l2] = hexToHsl(nextHex);
  // Handle hue wrap
  let dh = h2 - h1;
  if(dh > 180) dh -= 360;
  if(dh < -180) dh += 360;
  return hslToHex(
    (h1 + dh * ratio + 360) % 360,
    s1 + (s2-s1) * ratio,
    l1 + (l2-l1) * ratio
  );
}

// Given set shades (sparse array, nulls for unset), fill in all gaps
function fillInterpolated(shades) {
  const filled = [...shades];
  const setIdxs = shades.map((s,i) => s ? i : null).filter(i => i !== null);
  if(setIdxs.length === 0) return filled;

  // Extrapolate before first anchor
  if(setIdxs[0] > 0) {
    const [h,s,l] = hexToHsl(shades[setIdxs[0]]);
    for(let i = 0; i < setIdxs[0]; i++) {
      const steps = setIdxs[0] - i;
      filled[i] = hslToHex(h, Math.max(0, s - steps*3), Math.min(97, l + steps*7));
    }
  }
  // Extrapolate after last anchor
  if(setIdxs[setIdxs.length-1] < 8) {
    const last = setIdxs[setIdxs.length-1];
    const [h,s,l] = hexToHsl(shades[last]);
    for(let i = last+1; i <= 8; i++) {
      const steps = i - last;
      filled[i] = hslToHex(h, Math.min(100, s + steps*2), Math.max(5, l - steps*7));
    }
  }
  // Interpolate between set anchors
  for(let k = 0; k < setIdxs.length - 1; k++) {
    const a = setIdxs[k], b = setIdxs[k+1];
    for(let i = a+1; i < b; i++) {
      const ratio = (i - a) / (b - a);
      filled[i] = interpolateShade(shades[a], shades[b], ratio);
    }
  }
  return filled;
}

// Which shades are "set" (not interpolated) at this step
function getSetMask(step, g) {
  // step 1 sets index 4 (500)
  // step 2 sets 0 (100) and 8 (900)
  // step 3 sets 2 (300) and 6 (700)
  // step 4 sets 1,3,5,7
  const setByStep = {1:[4], 2:[0,8], 3:[2,6], 4:[1,3,5,7]};
  const set = new Set();
  for(let s=1; s <= step; s++) {
    (setByStep[s]||[]).forEach(i => set.add(i));
  }
  return set;
}

function renderWizard(g, hints) {
  const step = g.wizardStep || 1;
  const stepDef = WIZARD_STEPS[step-1];
  const setMask = getSetMask(step, g);

  // wizardSet tracks which indices were explicitly set by the user in the wizard
  if(!g.wizardSet) g.wizardSet = new Set([4]); // 500 is pre-set from baseHex

  // Build sparse array: only wizardSet indices have values
  const sparseShades = g.shades.map((sh, i) => g.wizardSet.has(i) ? sh.hex : null);
  const displayShades = fillInterpolated(sparseShades);

  const STEP_LABELS = ['Base','Edges','Midpoints','Gaps'];
  // Step progress dots
  const stepDots = WIZARD_STEPS.map((s,i) => {
    const isDone = step > s.id;
    const isActive = step === s.id;
    return `
    <div class="wizard-step-dot ${isDone?'done':''} ${isActive?'active':''}" onclick="goToWizardStep(${s.id})">
      <div class="wizard-step-circle ${isDone?'done':''} ${isActive?'active':''}">
        ${isDone ? '✓' : s.id}
      </div>
      <div class="wizard-step-label">${STEP_LABELS[i]}</div>
    </div>`;
  }).join('');

  // Color pickers for current step
  const pickerGroups = stepDef.shadeIndices.map(idx => {
    const name = SHADE_NAMES[idx];
    const hex = g.shades[idx]?.hex || g.baseHex;
    const lum = getLuminance(hex);
    const textCol = lum > 55 ? '#1a1a18' : '#ffffff';
    return `
    <div class="wizard-picker-group">
      <div class="wizard-picker-label">${name}</div>
      <div class="wizard-swatch-btn shade-active" style="background:${hex};" title="Click to pick shade ${name}">
        <input type="color" value="${hex}" oninput="wizardPickShade(${idx}, this.value)" onchange="wizardPickShade(${idx}, this.value)">
        <div style="position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:center;padding-bottom:4px;pointer-events:none;">
          <span style="font-size:9px;font-weight:700;color:${textCol};opacity:0.8;">${name}</span>
        </div>
      </div>
      <div class="wizard-swatch-hex">${hex}</div>
      <div style="font-size:9px;color:var(--text-faint);text-align:center;max-width:56px;line-height:1.3;">${(hints[name]||'').split(',')[0]}</div>
    </div>`;
  }).join('');

  // Full shade strip showing set vs interpolated vs empty
  const stripCells = g.shades.map((sh, i) => {
    const name = SHADE_NAMES[i];
    const isCurrentStep = stepDef.shadeIndices.includes(i);
    const isSetBefore = setMask.has(i) && !isCurrentStep;
    const dispHex = displayShades[i] || '#e8e8e4';
    const lum = getLuminance(dispHex);
    const textCol = lum > 55 ? '#1a1a18' : '#ffffff';
    let swatchClass = isCurrentStep ? 'current' : isSetBefore ? 'set' : 'interpolated';
    return `
    <div class="wizard-shade-cell">
      <div class="wizard-shade-swatch ${swatchClass}" style="background:${dispHex};">
        ${isSetBefore ? `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:9px;color:${textCol};font-weight:800;">✓</div>` : ''}
        ${isCurrentStep ? `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:9px;color:${textCol};font-weight:800;">●</div>` : ''}
      </div>
      <div class="wizard-shade-num">${name}</div>
    </div>`;
  }).join('');

  // Context preview per step
  const contextPreview = renderWizardPreview(step, g, displayShades);

  // Nav buttons
  const canGoBack = step > 1;
  const isLast = step === 4;
  const canFinish = step === 4;

  return `
  <div class="wizard-panel">
    <div class="wizard-steps">${stepDots}</div>

    <div class="wizard-instruction">${stepDef.instruction}</div>

    <div style="display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px;">Pick shade${stepDef.shadeIndices.length>1?'s':''}</div>
        <div class="wizard-pickers">${pickerGroups}</div>
      </div>
      <div style="flex:1;min-width:180px;">
        ${contextPreview}
      </div>
    </div>

    <div>
      <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">Scale overview</div>
      <div style="font-size:9px;color:var(--text-faint);margin-bottom:6px;">● = current step &nbsp; ✓ = already set &nbsp; faded = suggested interpolation</div>
      <div class="wizard-shade-strip">${stripCells}</div>
    </div>

    <div class="wizard-nav">
      <button class="btn btn-secondary btn-sm" onclick="goToWizardStep(${step-1})" ${!canGoBack?'disabled style="opacity:0.4;cursor:not-allowed;"':''}>← Back</button>
      <span class="wizard-nav-info">Step ${step} of 4</span>
      ${isLast
        ? `<button class="btn btn-primary btn-sm" onclick="wizardFinish()">✓ Apply & Done</button>`
        : `<button class="btn btn-primary btn-sm" onclick="goToWizardStep(${step+1})">Next →</button>`
      }
    </div>
  </div>`;
}

function renderWizardPreview(step, g, displayShades) {
  const hex = (i) => displayShades[i] || '#e8e8e4';
  const isGrey = g.type === 'grey';

  if(step === 1) {
    // Button preview
    const base = hex(4);
    const lum = getLuminance(base);
    const textCol = lum > 55 ? '#1a1a18' : '#ffffff';
    return `
    <div class="wizard-context-preview">
      <div class="wizard-context-label">Will it work as a button?</div>
      <div class="wizard-context-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="background:${base};border-radius:6px;padding:9px 16px;display:inline-flex;align-items:center;gap:7px;cursor:pointer;width:fit-content;">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 2v9M2 6.5h9" stroke="${textCol}" stroke-width="2" stroke-linecap="round"/></svg>
          <span style="color:${textCol};font-size:13px;font-weight:600;">Create project</span>
        </div>
        <div style="border:1.5px solid ${base};border-radius:6px;padding:9px 16px;display:inline-flex;align-items:center;gap:7px;cursor:pointer;width:fit-content;">
          <span style="color:${base};font-size:13px;font-weight:600;">View details</span>
        </div>
        <div style="font-size:10px;color:var(--text-faint);">Solid fill & outline variant</div>
      </div>
    </div>`;
  }

  if(step === 2) {
    // Alert preview — light bg (100) + dark text (900) + base accent (500)
    const light = hex(0), dark = hex(8), base = hex(4);
    const darkLum = getLuminance(dark);
    const darkText = darkLum > 55 ? '#1a1a18' : '#ffffff';
    const icon = isGrey
      ? `<svg width="13" height="13" viewBox="0 0 13 13" fill="none"><circle cx="6.5" cy="6.5" r="5.5" stroke="${dark}" stroke-width="1.5"/><path d="M6.5 4.5v3M6.5 9.2v.1" stroke="${dark}" stroke-width="1.5" stroke-linecap="round"/></svg>`
      : `<svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1L1 11h11L6.5 1z" stroke="${dark}" stroke-width="1.4" stroke-linejoin="round"/><path d="M6.5 5v3M6.5 9.5v.2" stroke="${dark}" stroke-width="1.4" stroke-linecap="round"/></svg>`;
    return `
    <div class="wizard-context-preview">
      <div class="wizard-context-label">Alert — uses 100 bg + 900 text</div>
      <div class="wizard-context-body" style="display:flex;flex-direction:column;gap:8px;">
        <div style="background:${light};border:1px solid ${hex(2)};border-left:3px solid ${base};border-radius:6px;padding:10px 12px;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;">
            ${icon}
            <span style="font-size:12px;font-weight:700;color:${dark};">Alert heading</span>
          </div>
          <div style="font-size:11px;color:${dark};opacity:0.75;margin-left:19px;">Description text using your 900 shade. Background is 100.</div>
        </div>
        <div style="display:flex;gap:8px;">
          <div style="font-size:10px;color:var(--text-faint);display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;border-radius:3px;background:${light};border:1px solid var(--border);display:inline-block;"></span>100 background
          </div>
          <div style="font-size:10px;color:var(--text-faint);display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;border-radius:3px;background:${dark};display:inline-block;"></span>900 text
          </div>
        </div>
      </div>
    </div>`;
  }

  if(step === 3) {
    // Show 300 between 100 and 500, and 700 between 500 and 900
    const c = [0,2,4,6,8].map(i => hex(i));
    return `
    <div class="wizard-context-preview">
      <div class="wizard-context-label">Do 300 and 700 feel balanced?</div>
      <div class="wizard-context-body">
        <div style="display:flex;gap:6px;margin-bottom:8px;">
          ${[0,2,4,6,8].map((idx,k) => {
            const h = hex(idx);
            const lum = getLuminance(h);
            const tc = lum > 55 ? '#1a1a18':'#ffffff';
            const isCurrent = idx === 2 || idx === 6;
            return `<div style="flex:1;height:36px;border-radius:4px;background:${h};border:${isCurrent?'2px solid var(--accent)':'1px solid rgba(0,0,0,0.06)'};display:flex;align-items:center;justify-content:center;">
              <span style="font-size:9px;font-weight:700;color:${tc};">${SHADE_NAMES[idx]}</span>
            </div>`;
          }).join('')}
        </div>
        <div style="font-size:10px;color:var(--text-faint);">Highlighted = midpoints you're setting now. Each should feel like a natural step between neighbors.</div>
      </div>
    </div>`;
  }

  // Step 4 — full scale
  return `
  <div class="wizard-context-preview">
    <div class="wizard-context-label">Complete scale</div>
    <div class="wizard-context-body">
      <div style="display:flex;gap:3px;margin-bottom:8px;">
        ${g.shades.map((sh,i) => {
          const h = displayShades[i] || '#e8e8e4';
          const lum = getLuminance(h);
          const tc = lum > 55 ? '#1a1a18':'#ffffff';
          const isCurrent = [1,3,5,7].includes(i);
          return `<div style="flex:1;height:28px;border-radius:3px;background:${h};border:${isCurrent?'2px solid var(--accent)':'1px solid rgba(0,0,0,0.04)'};display:flex;align-items:center;justify-content:center;">
            <span style="font-size:8px;font-weight:700;color:${tc};">${SHADE_NAMES[i]}</span>
          </div>`;
        }).join('')}
      </div>
      <div style="font-size:10px;color:var(--text-faint);">Highlighted = the last 4 gaps you're filling now. Adjust until the full scale feels balanced.</div>
    </div>
  </div>`;
}

// ==================== WIZARD ACTIONS ====================

function setMode(manual) {
  const g = getActiveGroup();
  if(!g) return;
  if(manual && g.shades.length !== 9) return;
  g.manualMode = manual;
  if(manual) {
    g.wizardStep = 1;
    // Only 500 (index 4) is pre-set from the base color
    g.wizardSet = new Set([4]);
    // Ensure shade 500 = baseHex
    g.shades[4] = { name: 500, hex: g.baseHex };
  }
  selectedShadeIdx = null;
  renderEditor();
}

function goToWizardStep(step) {
  if(step < 1 || step > 4) return;
  const g = getActiveGroup();
  if(!g) return;

  // Before going forward, lock in current step's interpolations
  if(step > (g.wizardStep||1)) {
    applyInterpolations(g, g.wizardStep||1);
  }

  g.wizardStep = step;
  renderEditor();
  renderSidebar();
  renderExport();
}

function applyInterpolations(g, currentStep) {
  if(!g.wizardSet) g.wizardSet = new Set([4]);
  const sparseShades = g.shades.map((sh, i) => g.wizardSet.has(i) ? sh.hex : null);
  const filled = fillInterpolated(sparseShades);
  g.shades.forEach((sh, i) => {
    if(!g.wizardSet.has(i) && filled[i]) {
      g.shades[i] = { name: SHADE_NAMES[i], hex: filled[i] };
    }
  });
}

function wizardPickShade(idx, hex) {
  const g = getActiveGroup();
  if(!g) return;
  g.shades[idx] = { name: SHADE_NAMES[idx], hex };
  if(!g.wizardSet) g.wizardSet = new Set([4]);
  g.wizardSet.add(idx);
  renderEditor();
  renderSidebar();
  renderExport();
}

function wizardFinish() {
  const g = getActiveGroup();
  if(!g) return;
  // Apply full interpolations to fill any remaining gaps
  if(!g.wizardSet) g.wizardSet = new Set([4]);
  const sparseShades = g.shades.map((sh, i) => g.wizardSet.has(i) ? sh.hex : null);
  const filled = fillInterpolated(sparseShades);
  g.shades = g.shades.map((sh, i) => ({ name: SHADE_NAMES[i], hex: filled[i] || sh.hex }));
  g.manualMode = false;
  g.wizardStep = 1;
  g.wizardSet = null;
  selectedShadeIdx = null;
  renderEditor();
  renderSidebar();
  renderExport();
}

function getNineShades(g) {
  const n = g.shades.length;
  if(n === 9) return g.shades;
  if(n === 0) return Array.from({length:9}, () => ({ name: 500, hex: g.baseHex || '#000000' }));

  const mapped = [];
  for(let i = 0; i < 9; i++) {
    const idx = n === 1 ? 0 : Math.round(i * (n - 1) / 8);
    const sh = g.shades[idx] || g.shades[0];
    mapped.push({
      name: sh?.name ?? 500,
      hex: sh?.hex || g.baseHex || '#000000',
    });
  }
  return mapped;
}

function renderPreviewCard(g) {
  const s = getNineShades(g);

  // SVG icons (inline, tiny)
  const iconCheck = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M2 6l3 3 5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const iconArrow = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-left:5px;"><path d="M2 6h8M7 3l3 3-3 3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const iconPlus  = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:4px;"><path d="M6 2v8M2 6h8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
  const iconAlert = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M6 1L1 10h10L6 1z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M6 5v2.5M6 9.2v.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  const iconInfo  = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:5px;"><circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M6 5.5v3M6 3.5v.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>`;
  const iconClose = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M2 2l8 8M10 2l-8 8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;

  const lum500 = getLuminance(s[4].hex);
  const btnText = lum500 > 55 ? s[8].hex : '#ffffff';

  if(g.type === 'grey') {
    return `
      <div style="background:${s[0].hex};border:1px solid ${s[2].hex};border-radius:6px;padding:14px;grid-column:span 2;">
        <div style="font-size:10px;font-weight:600;color:${s[4].hex};margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Light Mode Preview</div>
        <div style="font-size:15px;font-weight:700;color:${s[8].hex};margin-bottom:3px;">Page heading</div>
        <div style="font-size:13px;color:${s[6].hex};margin-bottom:10px;">Body text — secondary description goes here.</div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
          <div style="background:${s[1].hex};border:1px solid ${s[2].hex};border-radius:5px;padding:6px 12px;font-size:12px;font-weight:600;color:${s[7].hex};display:flex;align-items:center;">${iconPlus}Add item</div>
          <div style="border:1px solid ${s[3].hex};border-radius:5px;padding:6px 12px;font-size:12px;font-weight:500;color:${s[5].hex};">Cancel</div>
          <div style="font-size:11px;color:${s[4].hex};">● placeholder text</div>
        </div>
        <div style="height:1px;background:${s[2].hex};margin-bottom:10px;"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;">
          <div style="background:${s[1].hex};border:1px solid ${s[2].hex};border-radius:5px;padding:8px;font-size:11px;">
            <div style="color:${s[4].hex};margin-bottom:2px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Panel</div>
            <div style="color:${s[7].hex};font-weight:600;">Value 01</div>
          </div>
          <div style="background:${s[2].hex};border-radius:5px;padding:8px;font-size:11px;">
            <div style="color:${s[5].hex};margin-bottom:2px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Panel</div>
            <div style="color:${s[8].hex};font-weight:600;">Value 02</div>
          </div>
          <div style="background:${s[0].hex};border:1px dashed ${s[3].hex};border-radius:5px;padding:8px;font-size:11px;">
            <div style="color:${s[4].hex};margin-bottom:2px;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Empty</div>
            <div style="color:${s[3].hex};font-weight:400;">—</div>
          </div>
        </div>
      </div>
      <div style="background:${s[8].hex};border-radius:6px;padding:14px;grid-column:span 2;">
        <div style="font-size:10px;font-weight:600;color:${s[5].hex};margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Dark Mode Preview</div>
        <div style="font-size:15px;font-weight:700;color:${s[0].hex};margin-bottom:3px;">Page heading</div>
        <div style="font-size:13px;color:${s[3].hex};margin-bottom:10px;">Body text — secondary description.</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="background:${s[7].hex};border-radius:5px;padding:6px 12px;font-size:12px;font-weight:600;color:${s[1].hex};display:flex;align-items:center;">${iconPlus}Add item</div>
          <div style="border:1px solid ${s[6].hex};border-radius:5px;padding:6px 12px;font-size:12px;color:${s[3].hex};">Cancel</div>
        </div>
      </div>`;
  } else {
    // Determine role from semantic type
    const isError     = g.type === 'error';
    const isSuccess   = g.type === 'success';
    const isWarn      = g.type === 'warning';
    const isHighlight = g.type === 'highlight';

    const iconStar = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" style="display:inline-block;vertical-align:middle;margin-right:5px;"><path d="M6 1l1.5 3h3.2l-2.6 1.9 1 3L6 7.4l-3.1 1.5 1-3L1.3 4h3.2z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/></svg>';
    const roleIcon  = isError ? iconClose : isSuccess ? iconCheck : isWarn ? iconAlert : isHighlight ? iconStar : iconInfo;
    const roleLabel = isError ? 'Error — action failed' : isSuccess ? 'Success — action completed' : isWarn ? 'Warning — proceed with care' : isHighlight ? 'New feature available!' : (g.name + ' alert');

    return `
      <!-- Alert banner -->
      <div style="background:${s[0].hex};border:1px solid ${s[2].hex};border-left:3px solid ${s[5].hex};border-radius:6px;padding:12px 14px;grid-column:span 2;">
        <div style="font-size:12px;font-weight:600;color:${s[7].hex};display:flex;align-items:center;margin-bottom:3px;">${roleIcon}${roleLabel}</div>
        <div style="font-size:11px;color:${s[6].hex};margin-left:17px;">This is how ${s[0].hex} + ${s[7].hex} look together for an alert component.</div>
        <div style="margin-top:8px;margin-left:17px;display:flex;gap:6px;">
          <span style="background:${s[1].hex};border:1px solid ${s[3].hex};border-radius:4px;padding:3px 8px;font-size:10px;font-weight:600;color:${s[7].hex};display:inline-flex;align-items:center;">${iconCheck}Acknowledge</span>
          <span style="font-size:10px;color:${s[5].hex};display:inline-flex;align-items:center;cursor:pointer;padding:3px 4px;">Dismiss ${iconArrow}</span>
        </div>
      </div>

      <!-- Filled button -->
      <div style="background:${s[4].hex};border-radius:6px;padding:12px 16px;display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 2v10M2 7h10" stroke="${btnText}" stroke-width="2" stroke-linecap="round"/></svg>
        <span style="color:${btnText};font-size:13px;font-weight:600;">Primary Action</span>
      </div>

      <!-- Outline button -->
      <div style="border:1.5px solid ${s[4].hex};border-radius:6px;padding:12px 16px;display:flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;background:${s[0].hex};">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M2 7h10M8 3l4 4-4 4" stroke="${s[5].hex}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span style="color:${s[5].hex};font-size:13px;font-weight:600;">Secondary Action</span>
      </div>

      <!-- Badge row -->
      <div style="grid-column:span 2;display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:10px 0 2px;">
        <span style="background:${s[4].hex};color:${btnText};border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:3px;">${roleIcon}Active</span>
        <span style="background:${s[1].hex};color:${s[7].hex};border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;border:1px solid ${s[2].hex};display:inline-flex;align-items:center;gap:3px;">${roleIcon}Subtle badge</span>
        <span style="color:${s[5].hex};font-size:11px;font-weight:500;display:inline-flex;align-items:center;gap:3px;padding:3px 0;">${roleIcon}Icon + label</span>
        <span style="border:1.5px solid ${s[4].hex};color:${s[5].hex};border-radius:20px;padding:3px 10px;font-size:11px;font-weight:600;display:inline-flex;align-items:center;gap:3px;">${roleIcon}Outlined</span>
      </div>

      <!-- Dark variant -->
      <div style="background:${s[8].hex};border-radius:6px;padding:12px 14px;grid-column:span 2;">
        <div style="font-size:10px;font-weight:600;color:${s[5].hex};margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;">Dark / Inverted Variant</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="background:${s[4].hex};border-radius:5px;padding:6px 12px;font-size:12px;font-weight:600;color:${btnText};display:flex;align-items:center;gap:5px;">
            ${roleIcon.replace(/currentColor/g, btnText)}Action
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M2 6h8M7 3l3 3-3 3" stroke="${btnText}" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <span style="font-size:12px;color:${s[2].hex};">Text on dark: ${s[2].hex}</span>
        </div>
      </div>`;
  }
}

// ==================== SHADE EDITING ====================

function selectShade(idx) {
  selectedShadeIdx = selectedShadeIdx === idx ? null : idx;
  renderEditor();
}

function tweakShade(idx, prop, val) {
  const g = getActiveGroup();
  if(!g) return;
  val = parseInt(val);

  const [h,s,l] = hexToHsl(g.shades[idx].hex);
  let nh = h;
  let ns = s;
  let nl = l;

  if(prop === 'h') nh = val;
  if(prop === 's') ns = val;
  if(prop === 'l') nl = val;

  const ranges = getHslRanges(g, idx, nh, ns, nl);
  nh = clamp(nh, ranges.h.min, ranges.h.max);
  ns = clamp(ns, ranges.s.min, ranges.s.max);
  nl = clamp(nl, ranges.l.min, ranges.l.max);

  g.shades[idx].hex = hslToHex(nh, ns, nl);

  // update display without full re-render
  const strip = document.getElementById('shadeStrip');
  if(strip) {
    const swatches = strip.querySelectorAll('.shade-swatch');
    if(swatches[idx]) swatches[idx].style.background = g.shades[idx].hex;
    const hexes = strip.querySelectorAll('.shade-hex');
    if(hexes[idx]) hexes[idx].textContent = g.shades[idx].hex;
  }
  const hEl = document.getElementById('slHv');
  if(hEl) hEl.textContent = nh + 'deg';
  const sEl = document.getElementById('slSv');
  if(sEl) sEl.textContent = ns + '%';
  const lEl = document.getElementById('slLv');
  if(lEl) lEl.textContent = nl + '%';

  renderSidebar();
  renderExport();
}

// ==================== COLOR POPOVER ====================

function toggleColorPopover(e) {
  e.stopPropagation();
  const pop = document.getElementById('colorPopover');
  if(!pop) return;
  pop.classList.toggle('open');
}

function onColorPickerInput(val) {
  const hexInput = document.getElementById('colorHexInput');
  if(hexInput) hexInput.value = val;
  updateBase(val);
}

function onHexInput(val) {
  val = val.trim();
  if(!val.startsWith('#')) val = '#'+val;
  if(/^#[0-9a-fA-F]{6}$/.test(val)) {
    const picker = document.getElementById('colorPickerInput');
    if(picker) picker.value = val;
    updateBase(val);
  }
}

// Close popover on outside click
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('colorPickerWrap');
  if(wrap && !wrap.contains(e.target)) {
    const pop = document.getElementById('colorPopover');
    if(pop) pop.classList.remove('open');
  }
});

function updateBase(hex) {
  const g = getActiveGroup();
  if(!g) return;
  g.baseHex = hex;
  // update inline without full re-render
  const swatch = document.getElementById('colorSwatch');
  if(swatch) swatch.style.background = hex;
  const prevSwatch = document.getElementById('basePreviewSwatch');
  if(prevSwatch) prevSwatch.style.background = hex;
  const [bh,bs,bl] = hexToHsl(hex);
  const hexD = document.getElementById('baseHexDisplay');
  if(hexD) hexD.textContent = hex;
  const hslD = document.getElementById('baseHslDisplay');
  if(hslD) hslD.textContent = `hsl(${bh}, ${bs}%, ${bl}%)`;
  renderSidebar();
  renderExport();
}

function autoGenerate() {
  const g = getActiveGroup();
  if(!g) return;
  const genType = g.type === 'grey' ? 'grey' : 'primary';
  g.shades = generateShades(g.baseHex, genType, g.shades.length || 9);
  selectedShadeIdx = null;
  renderEditor();
  renderSidebar();
  renderExport();
}

// ==================== EXPORT ====================

function getCssVarName(groupName, shade) {
  // Use semantic name as-is for CSS vars (primary, error, success, warning, neutral)
  return `--color-${groupName.toLowerCase().replace(/\s+/g,'-')}-${shade}`;
}

function generateCSSVars() {
  if(!groups.length) return '/* No color groups defined yet */';
  let out = ':root {\n';
  groups.forEach(g => {
    out += `  /* ${g.name} */\n`;
    g.shades.forEach(s => {
      const [r,gr,b] = hexToRgb(s.hex);
      out += `  ${getCssVarName(g.name, s.name)}: ${s.hex};\n`;
    });
    out += '\n';
  });
  out += '}';
  return out;
}

function generateTailwind() {
  if(!groups.length) return '/* No color groups defined yet */';
  let out = `// tailwind.config.js\n`;
  out += `/** @type {import('tailwindcss').Config} */\n`;
  out += `module.exports = {\n  theme: {\n    extend: {\n      colors: {\n`;
  groups.forEach(g => {
    const key = g.name.toLowerCase().replace(/\s+/g,'-');
    out += `        '${key}': {\n`;
    g.shades.forEach(s => {
      out += `          ${s.name}: '${s.hex}',\n`;
    });
    out += `        },\n`;
  });
  out += `      },\n    },\n  },\n};\n`;
  return out;
}

function generateMUI() {
  if(!groups.length) return '// No color groups defined yet';
  let out = `// theme.js — MUI createTheme palette\n`;
  out += `import { createTheme } from '@mui/material/styles';\n\n`;

  // Build color objects
  groups.forEach(g => {
    const key = g.name.toLowerCase().replace(/\s+/g,'-');
    out += `const ${g.name.replace(/\s+/g,'')}Colors = {\n`;
    g.shades.forEach(s => {
      out += `  ${s.name}: '${s.hex}',\n`;
    });
    // Try to guess main, light, dark
    const s = getNineShades(g);
    out += `  main: '${s[4].hex}',\n`;
    out += `  light: '${s[2].hex}',\n`;
    out += `  dark: '${s[6].hex}',\n`;
    out += `  contrastText: '#ffffff',\n`;
    out += `};\n\n`;
  });

  out += `const theme = createTheme({\n  palette: {\n`;

  // Map types to MUI palette slots using g.type directly
  const greyGroup    = groups.find(g=>g.type==='grey');
  const primaryGroup = groups.find(g=>g.type==='primary');
  const errGroup     = groups.find(g=>g.type==='error');
  const warnGroup    = groups.find(g=>g.type==='warning');
  const succGroup    = groups.find(g=>g.type==='success');
  const hlGroup      = groups.find(g=>g.type==='highlight');

  if(primaryGroup) out += `    primary: ${primaryGroup.name.replace(/\s+/g,'')}Colors,\n`;
  if(hlGroup)      out += `    secondary: ${hlGroup.name.replace(/\s+/g,'')}Colors,\n`;
  if(errGroup)     out += `    error: ${errGroup.name.replace(/\s+/g,'')}Colors,\n`;
  if(warnGroup)    out += `    warning: ${warnGroup.name.replace(/\s+/g,'')}Colors,\n`;
  if(succGroup)    out += `    success: ${succGroup.name.replace(/\s+/g,'')}Colors,\n`;

  if(greyGroup) {
    out += `    grey: {\n`;
    greyGroup.shades.forEach(s => {
      out += `      ${s.name}: '${s.hex}',\n`;
    });
    out += `    },\n`;
  }

  out += `  },\n});\n\nexport default theme;\n`;
  return out;
}

function renderExport() {
  const body = document.getElementById('exportBody');
  let code='', lang='';

  if(currentTab==='css') {
    code = generateCSSVars();
    body.innerHTML = `
      <div class="export-info">Copy and paste into your <strong>index.css</strong> or global stylesheet.</div>
      <div class="code-block" id="codeOut">${escHtml(code)}<button class="copy-btn" onclick="copyCode()">Copy</button></div>
    `;
  } else if(currentTab==='tailwind') {
    code = generateTailwind();
    body.innerHTML = `
      <div class="export-info">Place in your <strong>tailwind.config.js</strong> → <code style="font-family:'DM Mono',monospace;background:var(--bg);padding:1px 5px;border-radius:3px;">theme.extend.colors</code>.</div>
      <div class="code-block" id="codeOut">${escHtml(code)}<button class="copy-btn" onclick="copyCode()">Copy</button></div>
    `;
  } else if(currentTab==='mui') {
    code = generateMUI();
    body.innerHTML = `
      <div class="export-info">Import and use in your <strong>theme.js</strong> with <code style="font-family:'DM Mono',monospace;background:var(--bg);padding:1px 5px;border-radius:3px;">ThemeProvider</code>.</div>
      <div class="code-block" id="codeOut">${escHtml(code)}<button class="copy-btn" onclick="copyCode()">Copy</button></div>
    `;
  }
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function switchTab(tab, btn) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  renderExport();
}

function copyCode() {
  const el = document.getElementById('codeOut');
  const text = el.textContent.replace(/^Copy$/m,'').trim();
  navigator.clipboard.writeText(text).then(()=>{
    const btn = el.querySelector('.copy-btn');
    btn.textContent = '✓ Copied!';
    btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},2000);
  });
}

function showExportAll() {
  // create a combined output in a new window
  const cssContent = `${generateCSSVars()}\n\n/* === TAILWIND (for reference) ===\n${generateTailwind()}\n*/\n\n/* === MUI (for reference) ===\n${generateMUI()}\n*/`;
  const win = window.open('','_blank','width=700,height=600');
  win.document.write(`<pre style="font-family:monospace;font-size:13px;padding:20px;background:#1a1a18;color:#e8e8e4;margin:0;min-height:100vh;">${escHtml(cssContent)}</pre>`);
}

// ==================== MODAL ====================

let selectedType = 'grey';

function openAddModal() {
  selectedType = 'grey';
  document.getElementById('modalName').value = '';
  document.getElementById('modalShadeCount').value = 9;
  document.getElementById('modalColor').value = '#718096';
  document.getElementById('modalHex').value = '#718096';
  document.getElementById('addModal').classList.add('open');
  document.getElementById('modalName').focus();
}

function closeModal() {
  document.getElementById('addModal').classList.remove('open');
}

function selectType(type, el) {
  selectedType = type;
  document.querySelectorAll('.type-option').forEach(t=>t.classList.remove('selected'));
  el.classList.add('selected');

  // suggest default name and color
  const defaults = {
    grey:      { name: 'Neutral',   color: '#718096' },
    primary:   { name: 'Primary',   color: '#2563eb' },
    error:     { name: 'Error',     color: '#dc2626' },
    warning:   { name: 'Warning',   color: '#d97706' },
    success:   { name: 'Success',   color: '#16a34a' },
    highlight: { name: 'Highlight', color: '#7c3aed' },
    accent:    { name: 'Accent',    color: '#0ea5e9' },
  };
  const d = defaults[type];
  if(!document.getElementById('modalName').value) {
    document.getElementById('modalName').value = d.name;
  }
  document.getElementById('modalColor').value = d.color;
  document.getElementById('modalHex').value = d.color;
}

function syncModalColor() {
  let val = document.getElementById('modalHex').value.trim();
  if(!val.startsWith('#')) val = '#'+val;
  if(/^#[0-9a-fA-F]{6}$/.test(val)) {
    document.getElementById('modalColor').value = val;
  }
}

document.getElementById('modalColor').addEventListener('input', function(){
  document.getElementById('modalHex').value = this.value;
});

function confirmAddGroup() {
  const name = document.getElementById('modalName').value.trim() || 'New Color';
  const hex = document.getElementById('modalColor').value;
  const countRaw = parseInt(document.getElementById('modalShadeCount').value, 10);
  const shadeCount = Math.max(1, Math.min(9, isNaN(countRaw) ? 9 : countRaw));
  closeModal();
  addGroup(name, selectedType, hex, shadeCount);
}

// close modal on overlay click
document.getElementById('addModal').addEventListener('click', function(e){
  if(e.target===this) closeModal();
});

// keyboard
document.addEventListener('keydown', e => {
  if(e.key==='Escape') closeModal();
  if(e.key==='Enter' && document.getElementById('addModal').classList.contains('open')) {
    confirmAddGroup();
  }
});

// ==================== INIT — start with full recommended setup ====================

addDefaultGroups();
</script>
</body>
</html>

